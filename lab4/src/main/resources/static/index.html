<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UI with Price Tickers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
</head>

<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-3xl font-bold text-gray-800 mb-2">Lab4: WebSocket</h1>
    <h2 id="status" class="text-lg text-blue-600 mb-6">Status: Not logged in</h2>

    <div class="flex gap-4 mb-8">
        <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="login()">
            Login
        </button>
        <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="getUserInfo()"
            id="getUserInfoButton">
            Get User Info
        </button>
    </div>

    <div class="w-full max-w-xl bg-white rounded-lg shadow p-4 h-24 overflow-y-auto text-sm text-gray-700 mb-4"
        id="infoBox">
        <p><em>Information about user will appear here...</em></p>
    </div>

    <h2 class="text-2xl font-bold text-gray-800 mb-2">Live Currency Prices</h2>
    <div class="flex justify-center mb-4"> <button
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600" onclick="requestCurrencyPrices()"
            id="getPricesButton">
            Get Currencies
        </button>
    </div>
    <div class="w-full max-w-xl bg-white rounded-lg shadow p-4 text-sm text-gray-700 min-h-[50px]" id="priceBox">
        <p><em>Click "Get Currencies" to display prices after logging in.</em></p>
    </div>

    <script>
        let stompClient = null;
        const configuredCurrencyPairs = ["BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT"];
        let isLoggedIn = false;

        let protobufRoot = null;
        let priceUpdateMessageType = null;

        // Define the Protobuf message structure as a string
        const protoDefinition = `
            syntax = "proto3";

            package com.example.lab4.protobuf;

            message PriceUpdate {
              string symbol = 1;
              string price = 2;
            }
        `;
        let isProtobufReady = false;

        try {
            const parsed = protobuf.parse(protoDefinition);
            protobufRoot = parsed.root;
            priceUpdateMessageType = protobufRoot.lookupType("com.example.lab4.protobuf.PriceUpdate");
            isProtobufReady = true;
            console.log("Protobuf ready.");
        } catch (err) {
            console.error("Failed to parse protobuf definition:", err);
        }



        function login() {
            window.location.href = '/auth/login';
        }

        function checkAuthStatus() {
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById("status");
                    if (data.loggedIn) {
                        statusEl.textContent = "Status: Logged in";
                        isLoggedIn = true;
                    } else {
                        statusEl.textContent = "Status: Not logged in";
                        isLoggedIn = false;
                        disconnectWebSocket();
                        clearPriceDisplay("<em>Click \"Get Currencies\" to display prices after logging in.</em>");
                    }
                })
                .catch(error => {
                    console.error("Error checking auth status:", error);
                    document.getElementById("status").textContent = "Status: Error checking auth";
                    isLoggedIn = false;
                    disconnectWebSocket();
                    clearPriceDisplay("<em>Error checking authentication status.</em>");
                });
        }

        function initializePriceDisplay() {
            const priceBox = document.getElementById("priceBox");
            priceBox.innerHTML = '';
            if (configuredCurrencyPairs.length === 0) {
                priceBox.innerHTML = '<p><em>Currency list for display is not configured.</em></p>';
                return;
            }
            configuredCurrencyPairs.forEach(pairSymbol => {
                const div = document.createElement('div');
                div.id = `price-${pairSymbol}`;
                const base = pairSymbol.length > 4 ? pairSymbol.substring(0, pairSymbol.length - 4) : pairSymbol;
                const quote = pairSymbol.length > 4 ? pairSymbol.substring(pairSymbol.length - 4) : "USD";
                div.innerHTML = `${base}/${quote}: <span class="font-semibold">Loading...</span>`;
                priceBox.appendChild(div);
            });
        }

        function clearPriceDisplay(message = "<em>Click \"Get Currencies\" to display prices after logging in.</em>") {
            const priceBox = document.getElementById("priceBox");
            priceBox.innerHTML = `<p>${message}</p>`;
        }

        async function getUserInfo() {
            const statusEl = document.getElementById("status");
            const infoBox = document.getElementById("infoBox");

            try {
                const res = await fetch('/user/info');
                if (res.ok) {
                    const userInfo = await res.json();
                    infoBox.innerHTML = `User Id: ${userInfo.userId}<br>User name: ${userInfo.username}`;
                } else if (res.status === 401) {
                    isLoggedIn = false;
                    statusEl.textContent = "Status: User not logged in";
                    infoBox.innerHTML = `<p><em>User not logged in. Please log in to see user info.</em></p>`;
                    disconnectWebSocket();
                    clearPriceDisplay("<em>Please log in to retrieve currency prices.</em>");
                } else {
                    infoBox.innerHTML = `<p><em>Error fetching user info: ${res.status}</em></p>`;
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
                infoBox.innerHTML = `<p><em>Error: ${error.message}</em></p>`;
            }
        }

        function requestCurrencyPrices() {
            if (!isLoggedIn) {
                clearPriceDisplay("<em>Please log in to retrieve currency prices.</em>");
                return;
            }

            if (!isProtobufReady) {
                const priceBox = document.getElementById("priceBox");
                priceBox.innerHTML = '<p style="color: orange;">Loading price data definition...</p>';
                console.warn("Protobuf definition not loaded yet.");
                return;
            }

            initializePriceDisplay();
            connectWebSocket();
        }


        function connectWebSocket() {
            if (stompClient !== null && stompClient.connected) {
                console.log('Already connected to WebSocket.');
                return;
            }

            // Endpoint from backend WebSocketConfig
            const socket = new SockJS('/ws/price');
            stompClient = Stomp.over(socket);
            stompClient.debug = null; // Set to console.log for verbose STOMP debugging

            stompClient.connect({}, function (frame) {
                console.log('Connected to backend WebSocket: ' + frame);
                stompClient.subscribe('/topic/prices', function (message) {
                    // Check if the message body is binary (ArrayBuffer)
                    if (message.body instanceof ArrayBuffer) {
                        if (priceUpdateMessageType) {
                            try {
                                // Use protobufjs decode method
                                // Decode expects Buffer or Uint8Array
                                const priceUpdate = priceUpdateMessageType.decode(new Uint8Array(message.body));

                                const buffer = new Uint8Array(event.data);

                                // Access fields directly from the decoded object
                                const updateData = {
                                    symbol: priceUpdate.symbol,
                                    price: priceUpdate.price
                                };

                                // Use your existing function to display the price
                                displayPrice(updateData);

                            } catch (e) {
                                console.error("Error decoding Protobuf message:", e);
                                // Handle deserialization errors
                            }
                        } else {
                            console.warn("Received binary message but Protobuf type not loaded.");
                        }
                    } else {
                        console.warn("Received non-binary message from /topic/prices:", message.body);
                        // Handle text messages if the backend sends them (e.g., error messages)
                    }
                });
            }, function (error) {
                console.error('STOMP connection error: ' + error);
                const priceBox = document.getElementById("priceBox");
                if (priceBox) {
                    priceBox.innerHTML = '<p style="color: red;">Failed to connect to the price server. Make sure you\'re logged in and the server is available.</p>';
                }
            });
        }

        function disconnectWebSocket() {
            if (stompClient !== null) {
                stompClient.disconnect(() => {
                    console.log('Disconnected from backend WebSocket.');
                });
                stompClient = null;
            }
        }

        function displayPrice(priceUpdate) {
            // Ensure symbol case matches the element IDs (often uppercase from Binance)
            const symbolUpperCase = priceUpdate.symbol.toUpperCase();
            const priceElement = document.getElementById(`price-${symbolUpperCase}`);

            if (priceElement) {
                const spanElement = priceElement.querySelector('span');
                if (spanElement) {
                    spanElement.textContent = priceUpdate.price;
                    // Optional: Add logic to show price change direction (e.g., color)
                    // This requires storing the previous price
                }
            } else {
                // Log if a price update arrives for a symbol we aren't displaying
                console.warn(`Element for displaying price ${symbolUpperCase} not found.`);
            }
        }

        window.addEventListener('load', checkAuthStatus);

    </script>

</body>

</html>